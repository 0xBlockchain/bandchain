const { expectRevert } = require("openzeppelin-test-helpers");
const BridgeWithCache = artifacts.require("BridgeWithCache");
const BridgeCacheConsumerMock = artifacts.require("BridgeCacheConsumerMock");

require("chai").should();

contract("BridgeWithCache", ([_, owner, alice, bob]) => {
  context(
    "Checking oracle state relaying and consumtion  (4 validators)",
    () => {
      beforeEach(async () => {
        this.template = [
          "bandchain.js",
          "13",
          "0x000000044c494e4b00000003555344000000066d656469616e00000000000f4240",
          "4",
          "3",
        ];
        this.cache = await BridgeWithCache.new(
          [
            ["0x634db8FC70651E63204f636a1c44D92f2689D169", 1000],
            ["0xd4D7099737dA368d7178DF89faA69d24aa9fdB0C", 1000],
            ["0x3715eCFC3D04f358A18482147Fd13C5f44FE8D7E", 1000],
            ["0x13559C6A3709C25969DC9a5776Ae19711C78CAD1", 1000],
          ],
          { from: owner },
        );

        this.consumer = await BridgeCacheConsumerMock.new(
          this.cache.address,
          this.template,
          { from: alice },
        );
      });

      it("should get correct configs from the consumer", async () => {
        (await this.consumer.bridgeCache())
          .toString()
          .should.eq(this.cache.address.toString());

        const {
          clientId,
          oracleScriptId,
          params,
          askCount,
          minCount,
        } = await this.consumer.requestTemplate();

        [
          clientId,
          oracleScriptId.toString(),
          params,
          askCount.toString(),
          minCount.toString(),
        ]
          .toString()
          .should.eq(this.template.toString());
      });

      it("should be able relay and get response from state", async () => {
        await expectRevert(
          this.cache.getLatestResponse(this.template),
          "RESPONSE_NOT_FOUND",
        );

        await this.cache.relay(
          "0x000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000580000000000000000000000000000000000000000000000000000000000000fe97cb9a38d230a749259ecc770da9cfdd74ee4c756d0864cd6b6585d8bd6420c8d202a64c3b0838294c7739241328770a2de1ff3dca3ad9b232c757e56d2f946b4c8ff4476683f2d1ac287e45fcf65f5620cf6cd544edc270782c4e1b4f79fd36fbe8845ee2469d1277adfaecb7c4df579c350c8081aaeaadd12acce9a654118c7541188c35dbb59cfaa713b03e7298d254cb825bd47d9dbda4e71175cc51ae5dd2f9d4c22bf1a2b5f8431437738bfcbf96b880b9e13794ca7a2c3ae57b95d02324e20e1377f0cc8b5433efe9781edd86eb436ba4ae39420d7d06dfd518c8ef4f3d116b641728ef153cc0572fdf97aad5134e444ae2bebff6d0913469460194f74295d1b086d8fcb67cbc1531c8eb27e263b3a299cb44bff1fc29c3d0340b2fe5676e340b9cffb37a989ca544e6bb780a2c78901d3fb33738768511a30617afa01d0e406f530fff2a2632212fefb2c30f47216f56765ae5b38445a194146248ec2600000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000107b08021197fe00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000026054ca23bc33faa08238c1339a3750540ecb685b863cd22d24486101d1048efd8421f6e0517f85c2bf612cf3e9a96cdd8339f7c9b9b83226e13fabde0461cc895e000000000000000000000000000000000000000000000000000000000000001b0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004c12240a207c2713c61747f41662ddfcb04434a89fcf7227178de0018c97767d20e820f24f10012a0c0889a4c7f70510a8db8e9c03321662616e642d6775616e79752d6465766e65742d322e35000000000000000000000000000000000000000084ceb011d139837faf48fc8279aca50ce9f284564ba6c110e219d9cadbaa216125a34c309c16cbba19f8cdc11eb13efefc6cb234be2f3bfeb6fce43245693863000000000000000000000000000000000000000000000000000000000000001b0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004c12240a207c2713c61747f41662ddfcb04434a89fcf7227178de0018c97767d20e820f24f10012a0c0889a4c7f70510f79f979103321662616e642d6775616e79752d6465766e65742d322e3500000000000000000000000000000000000000005f582ca5ba13b00b500269425dde1676979714e1a79ffdc7c18859e5b268f731613f3cd1a7c4f356818ccebd11633f8cd8d179e8acdf38f6859c65d57edbf9b7000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004c12240a207c2713c61747f41662ddfcb04434a89fcf7227178de0018c97767d20e820f24f10012a0c0889a4c7f70510ccc4b3ac03321662616e642d6775616e79752d6465766e65742d322e3500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c20000000000000000000000000000000000000000000000000000000000000fe9700000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000fe95000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000c62616e64636861696e2e6a7300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021000000044c494e4b00000003555344000000066d656469616e00000000000f42400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000004c40000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005ef1d200000000000000000000000000000000000000000000000000000000005ef1d20500000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000c62616e64636861696e2e6a7300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000044fc28000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000fe9514e0d046995b5795c0128fdecc3355bab8ec647a2f32d99b901f37077aef0682000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000fe956243104882de51c5bbe5a7db4a3bee045777e24021541df82f8f2952b52150bf000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000fe959c7a19e795874de82812f070486e41a6b3c65fae24c7119030e04692521f745e00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000fe9550b47545b64e3e8c836e51d24886e1ad30441409047f11c482e8f4343d8a778d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001b000000000000000000000000000000000000000000000000000000000000fe958efa4220fff819f4807f52c2b485e6e0a9ef2fe2e5957e19a72d39061240917c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002b000000000000000000000000000000000000000000000000000000000000fe9530a6119d0dc10cfeb2168b3f6788b7760b459d91ded2edc89c67b280a9bb8cc900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000006b000000000000000000000000000000000000000000000000000000000000fe95e01aabfa07e45bd5d6fe46940d4dc81b2f2d1d4c2422dd8275dd5936bdb36d480000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000ab000000000000000000000000000000000000000000000000000000000000fe9560c8a2f41832377f5ad12b49a8f7dd0c94669a2ea95675baae9a1da32cf4f78e00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000012b000000000000000000000000000000000000000000000000000000000000fe9538dd72b1e389eb8569935733e3a0121ae4c137685a81e5ca392929e47f9971400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000032b000000000000000000000000000000000000000000000000000000000000fe95c263f5848f452ed26e836aff8c3ae2f5e6ad7746613ba93505813e04a076ef200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000050a000000000000000000000000000000000000000000000000000000000000fe95fb9a3ca87d5daa011800589744a354b10fc6cd98fe011b836e18caf253f98f9b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000aab000000000000000000000000000000000000000000000000000000000000fe954fbc91af7d28dcb22fe3f5144e17efffb4044e585f4dd40c12ce6eb3bf4cba6d0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000d0000000000000000000000000000000000000000000000000000000000001466000000000000000000000000000000000000000000000000000000000000fe95ab14f0487b01f1b2fc450eb84381c7a66eacf20c138187949c02b23bc901a80b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000001ce4000000000000000000000000000000000000000000000000000000000000fe969221c1286ed5dec968b3495e7a77060701d1a059793e1b856447f30b22da79e8",
          { from: bob },
        );

        const {
          clientId,
          requestId,
          ansCount,
          requestTime,
          resolveTime,
          resolveStatus,
          result,
        } = await this.cache.getLatestResponse(this.template);

        [
          clientId,
          requestId,
          ansCount,
          requestTime,
          resolveTime,
          resolveStatus,
          result,
        ]
          .toString()
          .should.eq(
            [
              "bandchain.js",
              "1220",
              "4",
              "1592906240",
              "1592906245",
              "1",
              "0x000000000044fc28",
            ].toString(),
          );
      });

      it("should be able relay and update the state", async () => {
        await expectRevert(
          this.cache.getLatestResponse(this.template),
          "RESPONSE_NOT_FOUND",
        );

        // initial relay
        await this.cache.relay(
          "0x000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000580000000000000000000000000000000000000000000000000000000000000fe97cb9a38d230a749259ecc770da9cfdd74ee4c756d0864cd6b6585d8bd6420c8d202a64c3b0838294c7739241328770a2de1ff3dca3ad9b232c757e56d2f946b4c8ff4476683f2d1ac287e45fcf65f5620cf6cd544edc270782c4e1b4f79fd36fbe8845ee2469d1277adfaecb7c4df579c350c8081aaeaadd12acce9a654118c7541188c35dbb59cfaa713b03e7298d254cb825bd47d9dbda4e71175cc51ae5dd2f9d4c22bf1a2b5f8431437738bfcbf96b880b9e13794ca7a2c3ae57b95d02324e20e1377f0cc8b5433efe9781edd86eb436ba4ae39420d7d06dfd518c8ef4f3d116b641728ef153cc0572fdf97aad5134e444ae2bebff6d0913469460194f74295d1b086d8fcb67cbc1531c8eb27e263b3a299cb44bff1fc29c3d0340b2fe5676e340b9cffb37a989ca544e6bb780a2c78901d3fb33738768511a30617afa01d0e406f530fff2a2632212fefb2c30f47216f56765ae5b38445a194146248ec2600000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000107b08021197fe00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000026054ca23bc33faa08238c1339a3750540ecb685b863cd22d24486101d1048efd8421f6e0517f85c2bf612cf3e9a96cdd8339f7c9b9b83226e13fabde0461cc895e000000000000000000000000000000000000000000000000000000000000001b0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004c12240a207c2713c61747f41662ddfcb04434a89fcf7227178de0018c97767d20e820f24f10012a0c0889a4c7f70510a8db8e9c03321662616e642d6775616e79752d6465766e65742d322e35000000000000000000000000000000000000000084ceb011d139837faf48fc8279aca50ce9f284564ba6c110e219d9cadbaa216125a34c309c16cbba19f8cdc11eb13efefc6cb234be2f3bfeb6fce43245693863000000000000000000000000000000000000000000000000000000000000001b0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004c12240a207c2713c61747f41662ddfcb04434a89fcf7227178de0018c97767d20e820f24f10012a0c0889a4c7f70510f79f979103321662616e642d6775616e79752d6465766e65742d322e3500000000000000000000000000000000000000005f582ca5ba13b00b500269425dde1676979714e1a79ffdc7c18859e5b268f731613f3cd1a7c4f356818ccebd11633f8cd8d179e8acdf38f6859c65d57edbf9b7000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004c12240a207c2713c61747f41662ddfcb04434a89fcf7227178de0018c97767d20e820f24f10012a0c0889a4c7f70510ccc4b3ac03321662616e642d6775616e79752d6465766e65742d322e3500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c20000000000000000000000000000000000000000000000000000000000000fe9700000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000fe95000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000c62616e64636861696e2e6a7300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021000000044c494e4b00000003555344000000066d656469616e00000000000f42400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000004c40000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005ef1d200000000000000000000000000000000000000000000000000000000005ef1d20500000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000c62616e64636861696e2e6a7300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000044fc28000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000fe9514e0d046995b5795c0128fdecc3355bab8ec647a2f32d99b901f37077aef0682000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000fe956243104882de51c5bbe5a7db4a3bee045777e24021541df82f8f2952b52150bf000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000fe959c7a19e795874de82812f070486e41a6b3c65fae24c7119030e04692521f745e00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000fe9550b47545b64e3e8c836e51d24886e1ad30441409047f11c482e8f4343d8a778d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001b000000000000000000000000000000000000000000000000000000000000fe958efa4220fff819f4807f52c2b485e6e0a9ef2fe2e5957e19a72d39061240917c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002b000000000000000000000000000000000000000000000000000000000000fe9530a6119d0dc10cfeb2168b3f6788b7760b459d91ded2edc89c67b280a9bb8cc900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000006b000000000000000000000000000000000000000000000000000000000000fe95e01aabfa07e45bd5d6fe46940d4dc81b2f2d1d4c2422dd8275dd5936bdb36d480000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000ab000000000000000000000000000000000000000000000000000000000000fe9560c8a2f41832377f5ad12b49a8f7dd0c94669a2ea95675baae9a1da32cf4f78e00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000012b000000000000000000000000000000000000000000000000000000000000fe9538dd72b1e389eb8569935733e3a0121ae4c137685a81e5ca392929e47f9971400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000032b000000000000000000000000000000000000000000000000000000000000fe95c263f5848f452ed26e836aff8c3ae2f5e6ad7746613ba93505813e04a076ef200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000050a000000000000000000000000000000000000000000000000000000000000fe95fb9a3ca87d5daa011800589744a354b10fc6cd98fe011b836e18caf253f98f9b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000aab000000000000000000000000000000000000000000000000000000000000fe954fbc91af7d28dcb22fe3f5144e17efffb4044e585f4dd40c12ce6eb3bf4cba6d0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000d0000000000000000000000000000000000000000000000000000000000001466000000000000000000000000000000000000000000000000000000000000fe95ab14f0487b01f1b2fc450eb84381c7a66eacf20c138187949c02b23bc901a80b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000001ce4000000000000000000000000000000000000000000000000000000000000fe969221c1286ed5dec968b3495e7a77060701d1a059793e1b856447f30b22da79e8",
          { from: bob },
        );

        // relay to update
        await this.cache.relay(
          "0x000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005e000000000000000000000000000000000000000000000000000000000000005800000000000000000000000000000000000000000000000000000000000011af3b151a83106969efd6b01ea9d99b0567e71c0a348ab7271c3b1c225d54aa93284c347c0267f6f93ffc860fb1cd364778af0610c350664a81379f4f2fe407959a36810c2a3061ed162ec93551151e28a45d649102208b8e6fe06fb75ceebefd42f5314e9f61de2db28611e313d177df1b20d9e733aee454634667e17ecaa722633e4097dc6033082542a078f1e53746c122c6b81e5dd46d1a027bf708218e83337f9d4c22bf1a2b5f8431437738bfcbf96b880b9e13794ca7a2c3ae57b95d023244dc2519267ccbf959a1906e4d046aa0fbaeb4a122d66519b70779e3ff0bc00833ce247af7ceb492de346eb6ea79eb2461c6b3f97387cd25ce3a462daed3a554c95d1b086d8fcb67cbc1531c8eb27e263b3a299cb44bff1fc29c3d0340b2fe5674deac164a916c49f6591b2b05cc63ff5d8cf10d82f03f7acc295ec4183fd37e90e406f530fff2a2632212fefb2c30f47216f56765ae5b38445a194146248ec2600000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000107b080211f31a01000000000022480a20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000260444a87500e74a8b31fffce903e6ab87563548a4ea04bb541fc72f9bddc6e86b43b96a6c3d67a9df48883cebf8b113b2b4e347170a89815e363dac0209c5b0165000000000000000000000000000000000000000000000000000000000000001b0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004c12240a2095f8f788ce494eb9ee8e582555fcf9cd4b0d23da53eb0ef2c344d6baa4d7c84d10012a0c0885fec7f7051092c2bce401321662616e642d6775616e79752d6465766e65742d322e350000000000000000000000000000000000000000d54f44efa35b142d19bbc69cfaad4bdfe553f2c5ed739e46587b37b68098b9423f6a5ea8e2d0ecc8a8a0d601795910940bad9385aad9c2e20544e9cb80ac36d1000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004c12240a2095f8f788ce494eb9ee8e582555fcf9cd4b0d23da53eb0ef2c344d6baa4d7c84d10012a0c0885fec7f70510e2a18fda01321662616e642d6775616e79752d6465766e65742d322e350000000000000000000000000000000000000000c3b3200f319f967733a6a5e4e10b53516b0c3316a905ff15eee89b0edc02d2e80e1dce0d71bc1d5dbb119c5a13f4298b63e6dcfff3e5b3a1a7de370f05ccc738000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004c12240a2095f8f788ce494eb9ee8e582555fcf9cd4b0d23da53eb0ef2c344d6baa4d7c84d10012a0c0885fec7f7051090bc90f501321662616e642d6775616e79752d6465766e65742d322e3500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cc00000000000000000000000000000000000000000000000000000000000011af300000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000119df000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000c62616e64636861696e2e6a7300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021000000044c494e4b00000003555344000000066d656469616e00000000000f42400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000007500000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005ef1fd4a000000000000000000000000000000000000000000000000000000005ef1fd4d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000c62616e64636861696e2e6a7300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000045a22b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000119fb704bd733992fee86c8e00c567459f8d4d1cb77c78809d073ae8a5d8fb4de55450000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000011a050ca319b9669a8c8384de1a70dd4cb3bed3cc5a84db83a0cf12c47feadea5c5450000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000011a17c41dc3c3d692d9b3ab9c4db80c1c575a16a619d48330f862accd09b857aee73d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000011a9d2e0b0de214d1af2049437f088368b315db3e50ce7875e456fcd2111c5ab015a50000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000011ae9b93fdeb45e5166e01ab30d66310feb84640413869b3a7fc3bc952e3c566916d30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000310000000000000000000000000000000000000000000000000000000000011ae91170e546857b25e4ba809f0ec8412ad6e6678ea0c6a645a5ea2f850c22e1027e0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000510000000000000000000000000000000000000000000000000000000000011ae9c4ebf3ea175a4be796137b62c67bd9a41d7343593c3ad59ec0cecf225ba482490000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000d10000000000000000000000000000000000000000000000000000000000011ae9d2e131dc7b8fd671f3bee1dc94b7d4db1ca07fc5a8f36b88b4e7be9e4f3a45ae0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000900000000000000000000000000000000000000000000000000000000000001d10000000000000000000000000000000000000000000000000000000000011ae9669c4c5b5c0868e63b3fb589556679f15cd1cd1a3c7ca289593a3ce88b55a4640000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000003d10000000000000000000000000000000000000000000000000000000000011ae984d20f38681a54dee3b0d35aec32e3abdb5c2a3c4ea6b80241f024e0104e7a090000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000b00000000000000000000000000000000000000000000000000000000000007b00000000000000000000000000000000000000000000000000000000000011af0377cbb29eb766daab4298354bf28c3b0bb591c40a711a69a912ab83de2c731550000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000c2d0000000000000000000000000000000000000000000000000000000000011af285447dfdd2644bd0191970264ff604f5efb4d0caa9ebe2f6ee1eb6394a3c05e80000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000017ea0000000000000000000000000000000000000000000000000000000000011af273c53c48e1aad0617c90c98b238680f53038c62ee15ea1bbd4195bc3cd3d8f910000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000021a50000000000000000000000000000000000000000000000000000000000011af2ab14f0487b01f1b2fc450eb84381c7a66eacf20c138187949c02b23bc901a80b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000002cca0000000000000000000000000000000000000000000000000000000000011af270ae1091bf76b5581db6cd8af3cdbec3c89166c98836064b3c34f1c6704f9c82",
          { from: bob },
        );

        const {
          clientId,
          requestId,
          ansCount,
          requestTime,
          resolveTime,
          resolveStatus,
          result,
        } = await this.cache.getLatestResponse(this.template);

        [
          clientId,
          requestId,
          ansCount,
          requestTime,
          resolveTime,
          resolveStatus,
          result,
        ]
          .toString()
          .should.eq(
            [
              "bandchain.js",
              "1872",
              "4",
              "1592917322",
              "1592917325",
              "1",
              "0x000000000045a22b",
            ].toString(),
          );
      });

      it("should be able relay and consume state by consumer contract", async () => {
        // consume and fail
        await expectRevert(this.consumer.consumeCache(), "RESPONSE_NOT_FOUND");

        const {
          clientId,
          requestId,
          ansCount,
          requestTime,
          resolveTime,
          resolveStatus,
          result,
        } = await this.consumer.latestRes();

        [
          clientId,
          requestId.toString(),
          ansCount.toString(),
          requestTime.toString(),
          resolveTime.toString(),
          resolveStatus.toString(),
          result,
        ]
          .toString()
          .should.eq(["", "0", "0", "0", "0", "0", null].toString());

        // relay
        await this.cache.relay(
          "0x000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000580000000000000000000000000000000000000000000000000000000000000fe97cb9a38d230a749259ecc770da9cfdd74ee4c756d0864cd6b6585d8bd6420c8d202a64c3b0838294c7739241328770a2de1ff3dca3ad9b232c757e56d2f946b4c8ff4476683f2d1ac287e45fcf65f5620cf6cd544edc270782c4e1b4f79fd36fbe8845ee2469d1277adfaecb7c4df579c350c8081aaeaadd12acce9a654118c7541188c35dbb59cfaa713b03e7298d254cb825bd47d9dbda4e71175cc51ae5dd2f9d4c22bf1a2b5f8431437738bfcbf96b880b9e13794ca7a2c3ae57b95d02324e20e1377f0cc8b5433efe9781edd86eb436ba4ae39420d7d06dfd518c8ef4f3d116b641728ef153cc0572fdf97aad5134e444ae2bebff6d0913469460194f74295d1b086d8fcb67cbc1531c8eb27e263b3a299cb44bff1fc29c3d0340b2fe5676e340b9cffb37a989ca544e6bb780a2c78901d3fb33738768511a30617afa01d0e406f530fff2a2632212fefb2c30f47216f56765ae5b38445a194146248ec2600000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000107b08021197fe00000000000022480a2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000026054ca23bc33faa08238c1339a3750540ecb685b863cd22d24486101d1048efd8421f6e0517f85c2bf612cf3e9a96cdd8339f7c9b9b83226e13fabde0461cc895e000000000000000000000000000000000000000000000000000000000000001b0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004c12240a207c2713c61747f41662ddfcb04434a89fcf7227178de0018c97767d20e820f24f10012a0c0889a4c7f70510a8db8e9c03321662616e642d6775616e79752d6465766e65742d322e35000000000000000000000000000000000000000084ceb011d139837faf48fc8279aca50ce9f284564ba6c110e219d9cadbaa216125a34c309c16cbba19f8cdc11eb13efefc6cb234be2f3bfeb6fce43245693863000000000000000000000000000000000000000000000000000000000000001b0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004c12240a207c2713c61747f41662ddfcb04434a89fcf7227178de0018c97767d20e820f24f10012a0c0889a4c7f70510f79f979103321662616e642d6775616e79752d6465766e65742d322e3500000000000000000000000000000000000000005f582ca5ba13b00b500269425dde1676979714e1a79ffdc7c18859e5b268f731613f3cd1a7c4f356818ccebd11633f8cd8d179e8acdf38f6859c65d57edbf9b7000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004c12240a207c2713c61747f41662ddfcb04434a89fcf7227178de0018c97767d20e820f24f10012a0c0889a4c7f70510ccc4b3ac03321662616e642d6775616e79752d6465766e65742d322e3500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c20000000000000000000000000000000000000000000000000000000000000fe9700000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000fe95000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000d00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000c62616e64636861696e2e6a7300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021000000044c494e4b00000003555344000000066d656469616e00000000000f42400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000004c40000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000005ef1d200000000000000000000000000000000000000000000000000000000005ef1d20500000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000c62616e64636861696e2e6a7300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000044fc28000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000fe9514e0d046995b5795c0128fdecc3355bab8ec647a2f32d99b901f37077aef0682000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000fe956243104882de51c5bbe5a7db4a3bee045777e24021541df82f8f2952b52150bf000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000fe959c7a19e795874de82812f070486e41a6b3c65fae24c7119030e04692521f745e00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000fe9550b47545b64e3e8c836e51d24886e1ad30441409047f11c482e8f4343d8a778d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000001b000000000000000000000000000000000000000000000000000000000000fe958efa4220fff819f4807f52c2b485e6e0a9ef2fe2e5957e19a72d39061240917c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002b000000000000000000000000000000000000000000000000000000000000fe9530a6119d0dc10cfeb2168b3f6788b7760b459d91ded2edc89c67b280a9bb8cc900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000006b000000000000000000000000000000000000000000000000000000000000fe95e01aabfa07e45bd5d6fe46940d4dc81b2f2d1d4c2422dd8275dd5936bdb36d480000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000ab000000000000000000000000000000000000000000000000000000000000fe9560c8a2f41832377f5ad12b49a8f7dd0c94669a2ea95675baae9a1da32cf4f78e00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000012b000000000000000000000000000000000000000000000000000000000000fe9538dd72b1e389eb8569935733e3a0121ae4c137685a81e5ca392929e47f9971400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000032b000000000000000000000000000000000000000000000000000000000000fe95c263f5848f452ed26e836aff8c3ae2f5e6ad7746613ba93505813e04a076ef200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000050a000000000000000000000000000000000000000000000000000000000000fe95fb9a3ca87d5daa011800589744a354b10fc6cd98fe011b836e18caf253f98f9b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000aab000000000000000000000000000000000000000000000000000000000000fe954fbc91af7d28dcb22fe3f5144e17efffb4044e585f4dd40c12ce6eb3bf4cba6d0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000d0000000000000000000000000000000000000000000000000000000000001466000000000000000000000000000000000000000000000000000000000000fe95ab14f0487b01f1b2fc450eb84381c7a66eacf20c138187949c02b23bc901a80b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000001ce4000000000000000000000000000000000000000000000000000000000000fe969221c1286ed5dec968b3495e7a77060701d1a059793e1b856447f30b22da79e8",
          { from: bob },
        );

        // consume again
        await this.consumer.consumeCache();

        const x = await this.consumer.latestRes();

        [
          x.clientId,
          x.requestId,
          x.ansCount,
          x.requestTime,
          x.resolveTime,
          x.resolveStatus,
          x.result,
        ]
          .toString()
          .should.eq(
            [
              "bandchain.js",
              "1220",
              "4",
              "1592906240",
              "1592906245",
              "1",
              "0x000000000044fc28",
            ].toString(),
          );
      });
    },
  );
});
